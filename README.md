# ALIEXPRESS-BOT-NEW

אוטומציה מלאה לטלגרם שמאתרת פוסטים עם קישורי AliExpress, ממירה אותם ללינק שותף אישי מהפורטל שלך, כותבת פוסט חדש בעברית בסגנון דילים ישראלי, ומפרסמת לערוץ היעד – או מדווחת במצב DRY_RUN. כל ההרשאות והטוקנים נטענים מ־GitHub Secrets או ממשתני סביבה.

## מה השתדרג בגרסה הזו?
- **קבצי קונפיג חדשים לחלוטין** עם חלוקה ברורה ל־API/תבנית/Prefix של לינק שותף.
- **טעינת קונפיג מחמירה** (בדיקת חסרים, תיאור מצב הפעלה, כישלון מהיר אם אין מקור לינק שותף או רשימת ערוצים).
- **מחולל לינקים אישי** שמנסה תחילה API מהפורטל, אחר כך תבנית עם `{url}`, לבסוף Prefix – עם נירמול קישורים והסרת קישורי מקור כפולים.
- **פתרון קישורי s.click + נירמול מוצר** – עוקב אחרי רידיירקטים ואז ממיר כל כתובת ל־`/item/<id>.html` כדי לבנות לינק אישי קצר וישיר לדף המוצר, בלי לקפוץ לעמוד כללי.
- **קיצור לינק אישי מאומת** – אחרי שבנינו לינק שמכוון למוצר עצמו, אפשר לקרוא לאנדפוינט קיצור (אם הוגדר) כדי לקבל לינק קצר עם המזהה האישי שלך; אם הקיצור לא ברור שהוא למוצר, נשארים עם הלינק המאומת.
- **מחולל קופי חדש** לפי הפרומפט שסיכמנו: שאלה פתיחה, פתרון קצר, בולטים תכל'ס, נתוני מחיר/דירוג/הזמנות/קופונים כשיש, ולינק אישי אחד בלבד.
- **ניקוי קישורים אגרסיבי** – מוחק כל URL שאינו הלינק האישי ומוודא שהוא מופיע פעם אחת בלבד, גם אם המקור או המודל החזירו קישורי s.click מקודדים.
- **שילוב מדיה מהמקור** – אם להודעת המקור יש תמונה/מדיה, הפרסום ישלח אותה עם הקופי החדש; אם שליחה עם מדיה נכשלת, המערכת מנסה אוטומטית בלי מדיה.
- **דוחות ריצה**: סיכום לכל ערוץ (נסרק/מועמדים/נשלח/סיבות דילוג) וסיכום כולל. מצב DRY_RUN מדווח אבל לא שולח בפועל.
 - **תוקף קונפיג מספרי** – ערכים לא מספריים/אפסיים/שליליים נופלים לברירת מחדל עם אזהרה במקום להפיל את הריצה.
 - **לוג שקוף של לינק השותף** – רואים מאיזה מקור נבנה הלינק (API/תבנית/Prefix) עם סיומת מקוצרת כדי לוודא שזה האישי שלך.

## מבנה הרפו
```
bot/main.py                               # לוגיקת הבוט המלאה
.github/workflows/telegram_affiliate_bot.yml  # גיטהאב אקשנס מתוזמן
.env.example                              # תבנית משתני סביבה
requirements.txt                          # תלות פייתון
```

## משתנים נדרשים (Secrets בגיטהאב)
הגדר ב־**Settings → Secrets and variables → Actions**:

| שם | חובה? | הערה |
| --- | --- | --- |
| `TG_API_ID` | כן | מ־my.telegram.org |
| `TG_API_HASH` | כן | מ־my.telegram.org |
| `TG_SESSION` | כן | StringSession של החשבון שמריץ את הבוט |
| `TG_SOURCE_CHANNELS` | כן | רשימת ערוצי מקור מופרדים בפסיק (למשל `@source1,@source2`) |
| `TG_TARGET_CHANNEL` | כן | הערוץ/קבוצה שלך למשל `@my_channel` |
| `OPENAI_API_KEY` | כן | מפתח OpenAI |
| `AFFILIATE_API_ENDPOINT` | אחד מהשלושה | API שמחזיר לינק אישי (מומלץ) |
| `AFFILIATE_API_TOKEN` | לא | Bearer Token לאותו API |
| `AFFILIATE_PORTAL_LINK` | אחד מהשלושה | תבנית פורטל עם `{url}` או לינק מוכן מראש |
| `AFFILIATE_PREFIX` | אחד מהשלושה | Prefix ישן של "prefix + encoded URL" |
| `AFFILIATE_API_TIMEOUT` | לא | ברירת מחדל 5 שניות (זמן מקס' לחיבור/קריאה מה־API, חייב להיות חיובי) |
| `AFFILIATE_SHORTENER_ENDPOINT` | לא | אנדפוינט שמקבל `{ "url": "..." }` ומחזיר לינק קצר (נוסף על הזדהות במידת הצורך) |
| `AFFILIATE_SHORTENER_TOKEN` | לא | Bearer token לאנדפוינט הקיצור (אם צריך) |
| `AFFILIATE_SHORTENER_TIMEOUT` | לא | ברירת מחדל 4 שניות; זמן חיובי לקיצור לפני נפילה חזרה ללינק המלא |
| `RESOLVE_REDIRECTS` | לא | ברירת מחדל true – לעקוב אחרי קישורי s.click כדי לגלות את כתובת המוצר האמיתית |
| `RESOLVE_REDIRECT_TIMEOUT` | לא | ברירת מחדל 4 שניות (חיובי) לזמן העקיבה אחר רידיירקטים |
| `DRY_RUN` | לא | `true/false` (ברירת מחדל false) |
| `MAX_POSTS_PER_RUN` | לא | ברירת מחדל 5 |
| `MESSAGE_COOLDOWN_SECONDS` | לא | ברירת מחדל 5 |
| `MAX_MESSAGE_AGE_MINUTES` | לא | ברירת מחדל 240 |
| `MAX_MESSAGES_PER_CHANNEL` | לא | ברירת מחדל 80 |
| `MIN_VIEWS` | לא | ברירת מחדל 1500 |
| `REQUIRE_KEYWORDS` | לא | ברירת מחדל false |
| `KEYWORD_ALLOWLIST` | לא | רשימת מילות מפתח חובה (פסיקים) |
| `KEYWORD_BLOCKLIST` | לא | רשימת מילות חסימה (פסיקים) |

> סדר עדיפויות לינק שותף: **API** → **תבנית פורטל** → **Prefix**. אם אף אחד לא קיים – הריצה נכשלת בתחילת הבוט.
> ערכים מספריים אופציונליים: אם תשאיר ריק/רווחים בלבד, ייקח ברירת מחדל; אם תזין טקסט לא מספרי או ערך אפס/שלילי כשלא מותר – תודפס אזהרה והוא יחזור לברירת המחדל.

## איך זה עובד
1. טוען קונפיג ומציג תקציר: מצב DRY_RUN, מס' ערוצי מקור, יעד, מצב לינק שותף, מגבלת פוסטים.
2. סורק בכל ערוץ עד `MAX_MESSAGES_PER_CHANNEL` הודעות.
3. בוחר הודעות עם לינק AliExpress ומסנן לפי מילות מפתח/צפיות/גיל הודעה/בלוקליסט.
4. מפיק לינק שותף אישי מה־API/תבנית/Prefix, ומסיר כל קישור זר. אם ה־API
   מחזיר לינק שלא מזוהה עם המוצר (ללא ה־item id או קישור דף מוצר) – הוא
   נזרק ועוברים אוטומטית לתבנית/Prefix כדי לשמור על נחיתה לדף המוצר.
   אם מוגדר אנדפוינט קיצור, הוא נקרא על הלינק המאומת; אם הקיצור לא ברור שהוא
   שייך למוצר – נשארים עם הלינק המאומת כדי לשמור על נחיתה ישירה וקצרה.
5. מחולל טקסט חדש בעברית לפי התבנית שסיכמנו (שאלה פתיחה → פתרון קצר → בולטים → מחיר/דירוג/הזמנות/קופונים אם קיימים → בלוק לינק אישי). אם OpenAI מחזיר ריק – יוצר פוסט דיפולטיבי מינימלי.
6. מבטיח שהלינק האישי מופיע פעם אחת בדיוק. מוסיף מזהה `(id:<product_id>)`
   ומדלג על כפילויות באותה הרצה או כאלה שכבר פורסמו בערוץ היעד.
7. שולח לערוץ היעד (או מדווח בלבד ב־DRY_RUN), עם השהייה בין שליחות ומגבלת פוסטים לכל הרצה.
8. מדפיס סיכום לכל ערוץ ולריצה כולה, כולל ספירת דילוגים לפי סיבה.

## הרצה מקומית
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# מלא את .env לפי התבנית
export $(grep -v '^#' .env | xargs)

python -m bot.main
```

## GitHub Actions
ה־Workflow `.github/workflows/telegram_affiliate_bot.yml` מריץ את הבוט כל 30 דקות או ידנית. כל המשתנים נלקחים מ־Secrets. ניתן לשנות את `cron` לפי הצורך.

## טיפים לאבחון
- ריצת DRY_RUN תראה בלוגים מה היה נשלח אבל לא תפרסם כלום.
- אם "posted" נשאר 0: בדוק בלוג סיכום דילוגים (חוסר מילות מפתח, צפיות נמוכות, הודעה ישנה, כפילויות). אפשר להוריד `MIN_VIEWS`, לבטל `REQUIRE_KEYWORDS`, או להגדיל `MAX_MESSAGES_PER_CHANNEL` זמנית.
- ודא שהחשבון שב־`TG_SESSION` חבר בכל ערוצי המקור.
- אם הלינק האישי לא מופיע: ודא ש־API/תבנית/Prefix מוגדרים ושאינם ריקים/רווחים בלבד.
  אם ה־API מחזיר לינק כללי שלא מזהה את המוצר, הוא ייזרק לטובת התבנית/Prefix.
- אם הקריאה ל־API של הפורטל גורמת לעיכוב: אפשר להוריד את `AFFILIATE_API_TIMEOUT` (ברירת מחדל 5 שניות, חייב להיות חיובי) או להשאיר את `AFFILIATE_API_ENDPOINT` ריק כדי לעבור אוטומטית לתבנית/Prefix.
- אם אתה מקבל לינקים כלליים ולא מוצר ספציפי: ודא ש-`RESOLVE_REDIRECTS` מופעל (ברירת מחדל). המנוע מנרמל כל קישור ל-`/item/<id>.html` לפני בניית הלינק האישי, אבל אם המקור לא מפנה לדף מוצר אמיתי – יתקבל דף כללי. במקרה כזה בדוק שהקישור המקורי נכון.
- אם אחד המספרים מוגדר עם טקסט שגוי או ערך לא חיובי כשנדרש, הריצה לא תיעצר – תודפס אזהרה והערך יחזור לברירת המחדל.
