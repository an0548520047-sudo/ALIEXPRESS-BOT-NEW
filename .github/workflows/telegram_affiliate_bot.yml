name: Telegram Affiliate Bot

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      TG_API_ID: ${{ secrets.TG_API_ID }}
      TG_API_HASH: ${{ secrets.TG_API_HASH }}
      TG_SESSION: ${{ secrets.TG_SESSION }}
      TG_SOURCE_CHANNELS: ${{ secrets.TG_SOURCE_CHANNELS }}
      TG_TARGET_CHANNEL: ${{ secrets.TG_TARGET_CHANNEL }}
      ALIEXPRESS_APP_KEY: ${{ secrets.ALIEXPRESS_APP_KEY }}
      ALIEXPRESS_APP_SECRET: ${{ secrets.ALIEXPRESS_APP_SECRET }}
      AFFILIATE_API_ENDPOINT: "https://api-sg.aliexpress.com/sync"
      AFFILIATE_API_TIMEOUT: "15"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: "gpt-4o-mini"
      MAX_POSTS_PER_RUN: "10"
      MAX_MESSAGES_PER_CHANNEL: "50"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Load history cache
        uses: actions/cache@v4
        with:
          path: history.txt
          key: bot-history-${{ github.run_number }}
          restore-keys: |
            bot-history-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install telethon openai httpx

      # : 驻住转  拽爪   砖转拽转 bot 拽转
      - name: Debug - Show Files
        run: |
          echo "Current directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Files inside bot folder (if exists):"
          ls -la bot || echo "No bot folder found!"

      - name: Run bot
        run: |
          echo " STARTING BOT EXECUTION..."
          python -m bot.main

      - name: Save history
        if: always()
        run: |
          git config --global user.name "Bot"
          git config --global user.email "bot@example.com"
          git add -f history.txt || true
          git commit -m "Update history" || true
          git push
