name: Telegram Affiliate Bot

on:
  schedule:
    - cron: "*/30 * * * *"  # רץ כל 30 דקות
  workflow_dispatch:        # מאפשר הרצה ידנית

# הענקת הרשאות כתיבה לבוט כדי שיוכל לשמור את ההיסטוריה
permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      TG_API_ID: ${{ secrets.TG_API_ID }}
      TG_API_HASH: ${{ secrets.TG_API_HASH }}
      TG_SESSION: ${{ secrets.TG_SESSION }}
      TG_SOURCE_CHANNELS: ${{ secrets.TG_SOURCE_CHANNELS }}
      TG_TARGET_CHANNEL: ${{ secrets.TG_TARGET_CHANNEL }}
      ALIEXPRESS_APP_KEY: ${{ secrets.ALIEXPRESS_APP_KEY }}
      ALIEXPRESS_APP_SECRET: ${{ secrets.ALIEXPRESS_APP_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: "gpt-4o-mini"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # טעינת היסטוריה מהזיכרון של גיטהאב (אם קיים)
      - name: Load history cache
        uses: actions/cache@v4
        with:
          path: history.txt
          key: bot-history-${{ github.run_number }}
          restore-keys: |
            bot-history-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install telethon openai httpx

      - name: Run bot
        run: |
          python -m bot.main

      # שמירת קובץ ההיסטוריה חזרה ל-Repository
      - name: Save history to Git
        if: always()
        run: |
          git config --global user.name "Bot"
          git config --global user.email "bot@example.com"
          git add -f history.txt || true
          # נבדוק אם יש שינויים לפני שננסה לעשות קומיט
          if git diff --staged --quiet; then
            echo "No changes to history."
          else
            git commit -m "Update history [skip ci]"
            git push
          fi
